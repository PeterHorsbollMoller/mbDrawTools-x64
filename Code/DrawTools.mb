'*******************************************************************************
'** 	Created By Peter Horsbøll Møller, Pitney Bowes Business Insight
'** 	Program:	DrawTools
'** 	Modul:	DrawTools.mb
'**
'*******************************************************************************

'-------------------------------------
Include "MapBasic.def"
Include "Enums.def"
Include "Icons.def"
Include "Menu.def"
'**default constants...
Include "Library\Defaults.def"
Include "Library\MI_ICONS_X64.def"
Include "Library\RibbonElements.def"

'-------------------------------------
Include "Library\Types\T_MI_POINT.def"
Include "Library\DATETIMELib.def"
Include "Library\DEBUGLib.def"
Include "Library\ERRORLib.def"
Include "Library\MAPPERLib.def"
Include "Library\MATHLib.def"
Include "Library\OBJLib.def"
Include "Library\ProgramInfo.def"
Include "Library\RIBBONLib.def"
Include "Library\TABLELib.def"
Include "Library\Dialogs\DLGSelectTable.def"

Include "DrawTools.def"
Include "DLGIsoscelesTrapez.def"
Include "DLGArrow.def"
Include "DLGSetNodeCoordinate.def"

Dim	msIconsFile As String
'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'	nButtonPadID	ID of buttonpad to add the tools to
'	sButtonPadName	Name of button to add the tools to
'				If ID = 0 then the name will be used, otherwise the ID will used
'**********************************************************************************************''
Sub DTAddToolsToButtonPad(ByVal nButtonPadID As Integer, ByVal sButtonPadName As String)

OnError GoTo ErrorOccured

	If nButtonPadID <> 0 Then
		Alter ButtonPad ID nButtonPadID Add
			Separator
			ToolButton
				Calling DTRegionAdd
				Icon 17	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POLYGON
				HelpMsg "Add extra region to selected region\nAdd to selected region"
				ModifierKeys On
			ToolButton
				Calling DTRegionRemove
				Icon 19	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POLYGON
				HelpMsg "Remove drawn region from selected region\nRemove from selected region"
				ModifierKeys On
			ToolButton
				Calling DTPolylineAddNode
				Icon 21	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Add new point to selected polyline\nAdd point to selected polyline"
				ModifierKeys On
			ToolButton
				Calling DTPolylineAddStartNode
				Icon 23	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Add new start point to selected polyline\nAdd start point to selected polyline"
				ModifierKeys On
			ToolButton
				Calling DTPolylineAddEndNode
				Icon 25	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Add new end point to selected polyline\nAdd end point to selected polyline"
				ModifierKeys On
			ToolButton
				Calling DTNodeSetCoordinate
				Icon 25	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Set coordinate for specific node\nSet Node Coordinate"
			PushButton
				Calling DTPolylineremoveStartNode
				Icon 27	File DTGetIconsFile()
				HelpMsg "Remove start point from selected polyline\nRemove start point from selected polyline"
			PushButton
				Calling DTPolylineRemoveEndNode
				Icon 29	File DTGetIconsFile()
				HelpMsg "Remove end point from selected polyline\nRemove end point from selected polyline"
			Separator
			PushButton
				Calling DTCombineIntoNew
				Icon 31	File DTGetIconsFile()
				HelpMsg "Combine selected objects into new object\nCombine selected into new"
			ToolButton
				Calling DTCreateGaps
				Icon 33	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Insert Gaps into the editable layer where clicked\nAdd gaps to the editable layer"
				ModifierKeys On
	Else
		Alter ButtonPad sButtonPadName Add
			Separator
			ToolButton
				Calling DTRegionAdd
				Icon 17	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POLYGON
				HelpMsg "Add extra region to selected region\nAdd to selected region"
				ModifierKeys On
			ToolButton
				Calling DTRegionRemove
				Icon 19	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POLYGON
				HelpMsg "Remove drawn region from selected region\nRemove from selected region"
				ModifierKeys On
			ToolButton
				Calling DTPolylineAddNode
				Icon 21	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Add new point to selected polyline\nAdd point to selected polyline"
				ModifierKeys On
			ToolButton
				Calling DTPolylineAddStartNode
				Icon 23	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Add new start point to selected polyline\nAdd start point to selected polyline"
				ModifierKeys On
			ToolButton
				Calling DTPolylineAddEndNode
				Icon 25	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Add new end point to selected polyline\nAdd end point to selected polyline"
				ModifierKeys On
			ToolButton
				Calling DTNodeSetCoordinate
				Icon 25	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Set coordinate for specific node\nSet Node Coordinate"
			PushButton
				Calling DTPolylineremoveStartNode
				Icon 27	File DTGetIconsFile()
				HelpMsg "Remove start point from selected polyline\nRemove start point from selected polyline"
			PushButton
				Calling DTPolylineRemoveEndNode
				Icon 29	File DTGetIconsFile()
				HelpMsg "Remove end point from selected polyline\nRemove end point from selected polyline"
			Separator
			PushButton
				Calling DTCombineIntoNew
				Icon 31	File DTGetIconsFile()
				HelpMsg "Combine selected objects into new object\nCombine selected into new"
			ToolButton
				Calling DTCreateGaps
				Icon 33	File DTGetIconsFile()
				'Cursor nCorsor File FILE_DLL
				Cursor MI_CURSOR_CROSSHAIR
				DrawMode DM_CUSTOM_POINT
				HelpMsg "Insert Gaps into the editable layer where clicked\nAdd gaps to the editable layer"
				ModifierKeys On
	End If

	Call DTToggleDrawTools

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTAddToolsToButtonPad")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'	nButtonPadID	ID of buttonpad to add the tools to
'	sButtonPadName	Name of button to add the tools to
'				If ID = 0 then the name will be used, otherwise the ID will used
'**********************************************************************************************''
Sub DTAddToolsToRibbon()

Dim	nCtrlIdx As Integer,
	sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName As String

OnError GoTo ErrorOccured

	sTabName				= TAB_SPATIAL
	sGroupName			= TAB_GROUP_SPATIAL_EDIT
	sSplitButtonName		= "TransformSplitButton"
	sSplitButtonGroupName	= "TransformDropdownMenuGroup"

'	nCtrlIdx = RBNSplitButtonGroupAddControl("sepTransformSplitButton", "", ""
'		, ControlType_ContextMenuSeparator, sTabName, sGroupName
'		, sSplitButtonName, sSplitButtonGroupName)

	nCtrlIdx = RBNSplitButtonGroupAddControl("DTRegionAdd", "Add to Region", "", ControlType_ToolButton, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Add extra region to the selected region.", "Select a polygon from the editable layer.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\PolygonAdd_32.png")
		'Set DrawMode
		Call RBNControlSetDrawModeIdx(nCtrlIdx, DM_CUSTOM_POLYGON)
		'Set Cursor
		Call RBNControlSetMICursorIdx(nCtrlIdx, MI_CURSOR_CROSSHAIR, "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTRegionAdd")
	End If

	nCtrlIdx = RBNSplitButtonGroupAddControl("DTRegionRemove", "Remove from Region", "", ControlType_ToolButton, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Remove drawn region from selected region.", "Select a polygon from the editable layer.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\PolygonRemove_32.png")
		'Set DrawMode
		Call RBNControlSetDrawModeIdx(nCtrlIdx, DM_CUSTOM_POLYGON)
		'Set Cursor
		Call RBNControlSetMICursorIdx(nCtrlIdx, MI_CURSOR_CROSSHAIR, "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTRegionRemove")
	End If

	nCtrlIdx = RBNSplitButtonGroupAddControl("DTCombineIntoNew", "Combine Selected into New", "", ControlType_Button, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Combine selected objects into new object.", "Select multiple polygons and make sure you have an editable layer to insert the new object into.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\ObjectsCombine_32.png")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTCombineIntoNew")
	End If

	nCtrlIdx = RBNSplitButtonGroupAddControl("DTCreateGaps", "Add Gaps", "", ControlType_ToolButton, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Insert gaps from the editable layer where clicked into the editable layer.", "Make sure you have an editable layer.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\ObjectsGap_32.png")
		'Set DrawMode
		Call RBNControlSetDrawModeIdx(nCtrlIdx, DM_CUSTOM_POINT)
		'Set Cursor
		Call RBNControlSetMICursorIdx(nCtrlIdx, MI_CURSOR_LRG_CROSSHAIR, "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTCreateGaps")
	End If

	sTabName				= TAB_SPATIAL
	sGroupName			= TAB_GROUP_SPATIAL_EDIT
	sSplitButtonName		= "NodesSplitButton"
	sSplitButtonGroupName	= "NodesSplitButtonMenuGroup"

'	nCtrlIdx = RBNSplitButtonGroupAddControl("sepNodesSplitButton", "", "", ControlType_ContextMenuSeparator, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)

	nCtrlIdx = RBNSplitButtonGroupAddControl("DTPolylineAddNode", "Add Node", "", ControlType_ToolButton, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Add new node to selected polyline where clicked.", "Make sure you have selected a polyline from the editable layer.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\PolylineAddNode_32.png")
		'Set DrawMode
		Call RBNControlSetDrawModeIdx(nCtrlIdx, DM_CUSTOM_POINT)
		'Set Cursor
		Call RBNControlSetMICursorIdx(nCtrlIdx, MI_CURSOR_CROSSHAIR, "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTPolylineAddNode")
	End If

	nCtrlIdx = RBNSplitButtonGroupAddControl("DTPolylineAddStartNode", "Add Start Node", "", ControlType_ToolButton, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Add new start node to selected polyline where clicked.", "Make sure you have selected a polyline from the editable layer.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\PolylineAddStartNode_32.png")
		'Set DrawMode
		Call RBNControlSetDrawModeIdx(nCtrlIdx, DM_CUSTOM_POINT)
		'Set Cursor
		Call RBNControlSetMICursorIdx(nCtrlIdx, MI_CURSOR_CROSSHAIR, "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTPolylineAddStartNode")
	End If
	nCtrlIdx = RBNSplitButtonGroupAddControl("DTPolylineAddEndNode", "Add End Node", "", ControlType_ToolButton, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Add new end node to selected polyline where clicked.", "Make sure you have selected a polyline from the editable layer.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\PolylineAddEndNode_32.png")
		'Set DrawMode
		Call RBNControlSetDrawModeIdx(nCtrlIdx, DM_CUSTOM_POINT)
		'Set Cursor
		Call RBNControlSetMICursorIdx(nCtrlIdx, MI_CURSOR_CROSSHAIR, "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTPolylineAddEndNode")
	End If
	nCtrlIdx = RBNSplitButtonGroupAddControl("DTNodeSetCoordinate", "Set Node Coordinate", "", ControlType_ToolButton, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Set coordinate for specific node", "Make sure you have selected a polyline from the editable layer.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\NodeSetCoordinate_32.png")
		'Set DrawMode
		Call RBNControlSetDrawModeIdx(nCtrlIdx, DM_CUSTOM_POINT)
		'Set Cursor
		Call RBNControlSetMICursorIdx(nCtrlIdx, MI_CURSOR_CROSSHAIR, "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTNodeSetCoordinate")
	End If

	nCtrlIdx = RBNSplitButtonGroupAddControl("DTPolylineRemoveStartNode", "Remove Start Node", "", ControlType_Button, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Remove start node from the selected polyline.", "Make sure you have selected a polyline from the editable layer.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\PolylineRemoveStartNode_32.png")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTPolylineRemoveStartNode")
	End If
	nCtrlIdx = RBNSplitButtonGroupAddControl("DTPolylineRemoveEndNode", "Remove End Node", "", ControlType_Button, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Remove end node from the selected polyline.", "Make sure you have selected a polyline from the editable layer.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\PolylineRemoveEndNode_32.png")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTPolylineRemoveEndNode")
	End If

	sTabName				= TAB_SPATIAL
	sGroupName			= TAB_GROUP_SPATIAL_CREATE		'SpatialCreateBar
'	sSplitButtonName		= "NodesSplitButton"
'	sSplitButtonGroupName	= "NodesSplitButtonMenuGroup"
	sSplitButtonName		= "SpatialCreateInsertSplitButton"
	sSplitButtonGroupName	= "InsertRegionsMenuGroup"

	nCtrlIdx = RBNSplitButtonGroupAddControl("DTDrawArrow", "Arrow", "", ControlType_ToolButton, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Draw an Arrow", "Make sure you have an editable layer in your map.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\Arrows_32.png")
		'Set DrawMode
		Call RBNControlSetDrawModeIdx(nCtrlIdx, DM_CUSTOM_POLYLINE)
		'Set Cursor
		Call RBNControlSetMICursorIdx(nCtrlIdx, MI_CURSOR_CROSSHAIR, "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTDrawArrow")
	End If

	nCtrlIdx = RBNSplitButtonGroupAddControl("DTDrawIsocelesTrapez", "Isoceles Trapezoid", "", ControlType_ToolButton, sTabName, sGroupName, sSplitButtonName, sSplitButtonGroupName)
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Draw a Isoceles Trapezoid using direction and size details", "Make sure you have an editable layer in your map.")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, "", ApplicationDirectory$() & "Images\IsocelesTrapez_32.png")
		'Set DrawMode
		Call RBNControlSetDrawModeIdx(nCtrlIdx, DM_CUSTOM_LINE)
		'Set Cursor
		Call RBNControlSetMICursorIdx(nCtrlIdx, MI_CURSOR_CROSSHAIR, "")
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTDrawIsocelesTrapez")
	End If


	sTabName				= TAB_SPATIAL
	sGroupName			= TAB_GROUP_SPATIAL_CREATE
	nCtrlIdx = RBNGroupInsertControlBefore("DTNodeCreateAnglePoints", "Create Angle Node Points", "", ControlType_Button, sTabName, sGroupName, "GeoCodeSplitButton")
	If nCtrlIdx > 0 Then
		'Create & Set the button tooltip
		Call RBNControlSetToolTipIdx(nCtrlIdx, PRGIGetApplicationName(), "Create node points with minimum angle for polygons/polylines in a table.", "")
		'Set the button icon
		Call RBNControlSetIconsIdx(nCtrlIdx, CONTROL_SIZE_LARGE, MI_IMG_SPA_CALCANGLE_16, MI_IMG_SPA_CALCANGLE_32)
		'Set Custom MapBasic Handle to the button
		Call RBNControlSetCustomMBXHandlerIdx(nCtrlIdx, "DTCreateAnglePointAlong")
	End If

	Call DTToggleDrawTools

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTAddToolsToRibbon")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTWinFocusChangedHandler

Dim	nWID As Integer

OnError GoTo ErrorOccured

	Call DTToggleDrawTools
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTWinFocusChangedHandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTWinChangedHandler

OnError GoTo ErrorOccured

	Call DTToggleDrawTools
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTWinChangedHandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTSelChangedHandler

OnError GoTo ErrorOccured

	Call DTToggleDrawTools
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTSelChangedHandler")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTToggleDrawTools

Dim	nWID, nEditLayerID As Integer

OnError GoTo ErrorOccured

	If SystemInfo(SYS_INFO_MAPINFO_INTERFACE) = MIINTERFACE_CLASSICMENU Then
		Alter Button DTRegionAdd 			Enable
		Alter Button DTRegionRemove			Enable
		Alter Button DTPolylineAddNode		Enable
		Alter Button DTPolylineAddStartNode	Enable
		Alter Button DTPolylineAddEndNode		Enable
		Alter Button DTPolylineRemoveStartNode	Enable
		Alter Button DTPolylineRemoveEndNode	Enable
		Alter Button DTCombineIntoNew			Enable
		Alter Button DTCreateGaps			Enable

		nWID		= FrontWindow()

		If SelectionInfo(SEL_INFO_NROWS) <> 1 Then
			Alter Button DTRegionAdd 			Disable
			Alter Button DTRegionRemove			Disable
			Alter Button DTPolylineAddNode		Disable
			Alter Button DTPolylineAddStartNode	Disable
			Alter Button DTPolylineAddEndNode		Disable
			Alter Button DTPolylineRemoveStartNode	Disable
			Alter Button DTPolylineRemoveEndNode	Disable
		End If
		If SelectionInfo(SEL_INFO_NROWS) < 2 Then
			Alter Button DTCombineIntoNew			Disable
		End If

		If nWID = 0 Then
			Alter Button DTRegionAdd 			Disable
			Alter Button DTRegionRemove			Disable
			Alter Button DTPolylineAddNode		Disable
			Alter Button DTPolylineAddStartNode	Disable
			Alter Button DTPolylineAddEndNode		Disable
			Alter Button DTPolylineRemoveStartNode	Disable
			Alter Button DTPolylineRemoveEndNode	Disable
			Alter Button DTCombineIntoNew			Disable
			Alter Button DTCreateGaps			Disable
		Else
			If WindowInfo(nWID, WIN_INFO_TYPE) <> WIN_MAPPER Then
				Alter Button DTRegionAdd 			Disable
				Alter Button DTRegionRemove			Disable
				Alter Button DTPolylineAddNode		Disable
				Alter Button DTPolylineAddStartNode	Disable
				Alter Button DTPolylineAddEndNode		Disable
				Alter Button DTPolylineRemoveStartNode	Disable
				Alter Button DTPolylineRemoveEndNode	Disable
				Alter Button DTCombineIntoNew			Disable
				Alter Button DTCreateGaps			Disable
			Else

				nEditLayerID	= MapperInfo(nWID, MAPPER_INFO_EDIT_LAYER)
				If nEditLayerID < 1 Then
					Alter Button DTRegionAdd 			Disable
					Alter Button DTRegionRemove			Disable
					Alter Button DTPolylineAddNode		Disable
					Alter Button DTPolylineAddStartNode	Disable
					Alter Button DTPolylineAddEndNode		Disable
					Alter Button DTPolylineRemoveStartNode	Disable
					Alter Button DTPolylineRemoveEndNode	Disable
					Alter Button DTCreateGaps			Disable
				Else
					If LayerInfo(nWID, nEditLayerID, LAYER_INFO_NAME) <> SelectionInfo(SEL_INFO_TABLENAME) Then
						Alter Button DTRegionAdd 			Disable
						Alter Button DTRegionRemove			Disable
						Alter Button DTPolylineAddNode		Disable
						Alter Button DTPolylineAddStartNode	Disable
						Alter Button DTPolylineAddEndNode		Disable
						Alter Button DTPolylineRemoveStartNode	Disable
						Alter Button DTPolylineRemoveEndNode	Disable
					End If
				End If
			End If
		End If
	Else
		Call RBNGroupEnableControls(  "", "", "DTRegionAdd", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTRegionRemove", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTPolylineAddNode", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTPolylineAddStartNode", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTPolylineAddEndNode", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTNodeSetCoordinate", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveStartNode", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveEndNode", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTCombineIntoNew", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTCreateGaps", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTDrawArrow", TRUE)
		Call RBNGroupEnableControls(  "", "", "DTDrawIsocelesTrapez", TRUE)

		nWID		= FrontWindow()

		If SelectionInfo(SEL_INFO_NROWS) <> 1 Then
			Call RBNGroupEnableControls(  "", "", "DTRegionAdd", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTRegionRemove", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineAddNode", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineAddStartNode", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineAddEndNode", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTNodeSetCoordinate", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveStartNode", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveEndNode", FALSE)
		End If
		If SelectionInfo(SEL_INFO_NROWS) < 2 Then
			Call RBNGroupEnableControls(  "", "", "DTCombineIntoNew", FALSE)
		End If

		If nWID = 0 Then
			Call RBNGroupEnableControls(  "", "", "DTRegionAdd", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTRegionRemove", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineAddNode", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineAddStartNode", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineAddEndNode", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTNodeSetCoordinate", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveStartNode", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveEndNode", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTCombineIntoNew", FALSE)
			Call RBNGroupEnableControls(  "", "", "DTCreateGaps", FALSE)
		Else
			If WindowInfo(nWID, WIN_INFO_TYPE) <> WIN_MAPPER Then
				Call RBNGroupEnableControls(  "", "", "DTRegionAdd", FALSE)
				Call RBNGroupEnableControls(  "", "", "DTRegionRemove", FALSE)
				Call RBNGroupEnableControls(  "", "", "DTPolylineAddNode", FALSE)
				Call RBNGroupEnableControls(  "", "", "DTPolylineAddStartNode", FALSE)
				Call RBNGroupEnableControls(  "", "", "DTPolylineAddEndNode", FALSE)
				Call RBNGroupEnableControls(  "", "", "DTNodeSetCoordinate", FALSE)
				Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveStartNode", FALSE)
				Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveEndNode", FALSE)
				Call RBNGroupEnableControls(  "", "", "DTCombineIntoNew", FALSE)
				Call RBNGroupEnableControls(  "", "", "DTCreateGaps", FALSE)
			Else

				nEditLayerID	= MapperInfo(nWID, MAPPER_INFO_EDIT_LAYER)
				If nEditLayerID < 1 Then
					Call RBNGroupEnableControls(  "", "", "DTRegionAdd", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTRegionRemove", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTPolylineAddNode", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTPolylineAddStartNode", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTPolylineAddEndNode", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTNodeSetCoordinate", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveStartNode", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveEndNode", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTCombineIntoNew", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTCreateGaps", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTDrawArrow", FALSE)
					Call RBNGroupEnableControls(  "", "", "DTDrawIsocelesTrapez", FALSE)
				Else
					If LayerInfo(nWID, nEditLayerID, LAYER_INFO_NAME) <> SelectionInfo(SEL_INFO_TABLENAME) Then
						Call RBNGroupEnableControls(  "", "", "DTRegionAdd", FALSE)
						Call RBNGroupEnableControls(  "", "", "DTRegionRemove", FALSE)
						Call RBNGroupEnableControls(  "", "", "DTPolylineAddNode", FALSE)
						Call RBNGroupEnableControls(  "", "", "DTPolylineAddStartNode", FALSE)
						Call RBNGroupEnableControls(  "", "", "DTPolylineAddEndNode", FALSE)
						Call RBNGroupEnableControls(  "", "", "DTNodeSetCoordinate", FALSE)
						Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveStartNode", FALSE)
						Call RBNGroupEnableControls(  "", "", "DTPolylineRemoveEndNode", FALSE)
					End If
				End If
			End If
		End If
	End If

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTToggleDrawTools")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTRegionAdd

OnError GoTo ErrorOccured

Dim	oDrawn, oExisting As Object

OnError GoTo ErrorOccured

	Set CoordSys Table Selection
	oDrawn	= CommandInfo(CMD_INFO_CUSTOM_OBJ)

	Fetch First From Selection
	oExisting	= Selection.OBJ

	Do Case ObjectInfo(oExisting, OBJ_INFO_TYPE)
		Case OBJ_TYPE_RECT, OBJ_TYPE_ELLIPSE, OBJ_TYPE_ROUNDRECT
			oExisting = ConvertToRegion(oExisting)
		Case OBJ_TYPE_REGION
			'**continue Please
		Case Else
			Note "Please select an area based object to use this tool!"
			Exit Sub
	End Case

	Update Selection
		Set OBJ = Combine(oExisting, oDrawn)

	Close Table SelectionInfo(SEL_INFO_SELNAME)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTRegionAdd")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTRegionRemove

Dim	oDrawn, oExisting As Object

OnError GoTo ErrorOccured

	Set CoordSys Table Selection
	oDrawn	= CommandInfo(CMD_INFO_CUSTOM_OBJ)

	Fetch First From Selection
	oExisting	= Selection.OBJ

	Do Case ObjectInfo(oExisting, OBJ_INFO_TYPE)
		Case OBJ_TYPE_RECT, OBJ_TYPE_ELLIPSE, OBJ_TYPE_ROUNDRECT
			oExisting = ConvertToRegion(oExisting)
		Case OBJ_TYPE_ARC
			oExisting = ConvertToPline(oExisting)
		Case OBJ_TYPE_REGION, OBJ_TYPE_LINE, OBJ_TYPE_PLINE
			'**continue Please
		Case Else
			Note "Please select an area based object to use this tool!"
			Exit Sub
	End Case

	Update Selection
		Set OBJ = Erase(oExisting, oDrawn)

	Close Table SelectionInfo(SEL_INFO_SELNAME)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTRegionRemove")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTPolylineAddNode

Dim	oExisting As Object,
	i, nSegment, nNode, nSegmentNearest, nNodeNearest As Integer,
	fX, fY, fShortestDistance, fDistance As Float

OnError GoTo ErrorOccured

'	Set CoordSys Window FrontWindow()
	Set CoordSys Table Selection
	fX	= CommandInfo(CMD_INFO_X)
	fY	= CommandInfo(CMD_INFO_Y)

	Fetch First From Selection
	oExisting	= Selection.OBJ

	Do Case ObjectInfo(oExisting, OBJ_INFO_TYPE)
		Case OBJ_TYPE_LINE
			oExisting = ConvertToPline(oExisting)
		Case OBJ_TYPE_PLINE
			'**continue Please
		Case Else
			Note "Please select a line or a polyline to use this tool!"
			Exit Sub
	End Case

	fShortestDistance	= 1000000	'meters, hoping that the users has clicked nearer than this

	For nSegment = 1 To ObjectInfo(oExisting, OBJ_INFO_NPOLYGONS)
		For i = 1 To 2
			If i = 1 Then
				nNode = 1
			Else
				nNode = ObjectInfo(oExisting, OBJ_INFO_NPOLYGONS + nSegment)
			End If

			fDistance	= Distance(fX, fY, ObjectNodeX(oExisting, nSegment, nNode), ObjectNodeY(oExisting, nSegment, nNode), "m")
			If fDistance < fShortestDistance Then
				fShortestDistance	= fDistance
				nSegmentNearest	= nSegment
				nNodeNearest	= nNode
			End If
		Next
	Next	'nSegment

	If nNodeNearest > 1 Then
		'**Adding a new node after the last - need to add one to the node number
		nNodeNearest		= nNodeNearest + 1
	End If

	Alter Object oExisting
		Node Add Position nSegmentNearest, nNodeNearest ( fX, fY )

	Update Selection
		Set OBJ = oExisting

	Close Table SelectionInfo(SEL_INFO_SELNAME)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTPolylineAddNode")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTPolylineAddStartNode

Dim	oExisting As Object,
	nSegment, nNode As Integer,
	fX, fY As Float

OnError GoTo ErrorOccured

'	Set CoordSys Window FrontWindow()
	Set CoordSys Table Selection
	fX	= CommandInfo(CMD_INFO_X)
	fY	= CommandInfo(CMD_INFO_Y)

	Fetch First From Selection
	oExisting	= Selection.OBJ

	Do Case ObjectInfo(oExisting, OBJ_INFO_TYPE)
		Case OBJ_TYPE_LINE
			oExisting = ConvertToPline(oExisting)
		Case OBJ_TYPE_PLINE
			'**continue Please
		Case Else
			Note "Please select a line or a polyline to use this tool!"
			Exit Sub
	End Case

	nSegment	= 1
	nNode		= 1

	Alter Object oExisting
		Node Add Position nSegment, nNode ( fX, fY )

	Update Selection
		Set OBJ = oExisting

	Close Table SelectionInfo(SEL_INFO_SELNAME)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTPolylineAddStartNode")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTPolylineAddEndNode

Dim	oExisting As Object,
	nSegment, nNode As Integer,
	fX, fY As Float

OnError GoTo ErrorOccured

'	Set CoordSys Window FrontWindow()
	Set CoordSys Table Selection
	fX	= CommandInfo(CMD_INFO_X)
	fY	= CommandInfo(CMD_INFO_Y)

	Fetch First From Selection
	oExisting	= Selection.OBJ

	Do Case ObjectInfo(oExisting, OBJ_INFO_TYPE)
		Case OBJ_TYPE_LINE
			oExisting = ConvertToPline(oExisting)
		Case OBJ_TYPE_PLINE
			'**continue Please
		Case Else
			Note "Please select a line or a polyline to use this tool!"
			Exit Sub
	End Case

	nSegment	= ObjectInfo(oExisting, OBJ_INFO_NPOLYGONS)
	nNode	= ObjectInfo(oExisting, OBJ_INFO_NPOLYGONS + nSegment)

	nNode	= nNode + 1
	Alter Object oExisting
		Node Add Position nSegment, nNode ( fX, fY )

	Update Selection
		Set OBJ = oExisting

	Close Table SelectionInfo(SEL_INFO_SELNAME)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTPolylineAddEndNode")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes
'Parameters:
'
'**********************************************************************************************''
Sub DTNodeSetCoordinate

Dim	oExisting, oPoint As Object,
	nSegment, nNode As Integer,
	fX, fY, fTolerance As Float

OnError GoTo ErrorOccured

	Set CoordSys Table Selection
	fX		= CommandInfo(CMD_INFO_X)
	fY		= CommandInfo(CMD_INFO_Y)
	oPoint	= CreatePoint(fX, fY)

	Fetch First From Selection
	oExisting	= Selection.OBJ

	Do Case ObjectInfo(oExisting, OBJ_INFO_TYPE)
		Case OBJ_TYPE_PLINE, OBJ_TYPE_REGION
			'**continue Please
		Case Else
			Note "Please select a polyline or polygon/region to use this tool!"
			Close Table SelectionInfo(SEL_INFO_SELNAME)
			Exit Sub
	End Case

	fTolerance	= 1	'meters	//TODO: Change the tolerance to depend on the the map zoom, say 1/100 or 1/1000 of the map width
	If not OBJFindSegmentAndNode(oExisting, oPoint, fTolerance, nSegment, nNode) Then
		Note "Try to click a bit closer to the node you want to modify!"
		Close Table SelectionInfo(SEL_INFO_SELNAME)
		Exit Sub
	End If

	If not DLGSetNodeCoordinate(oExisting, nSegment, nNode) Then
		Close Table SelectionInfo(SEL_INFO_SELNAME)
		Exit Sub
	End If

	Update Selection
		Set OBJ = oExisting

	Close Table SelectionInfo(SEL_INFO_SELNAME)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTNodeSetCoordinate")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTPolylineRemoveStartNode

Dim	oExisting As Object,
	nSegment, nNode As Integer,
	fX, fY As Float

OnError GoTo ErrorOccured

	Fetch First From Selection
	oExisting	= Selection.OBJ

	Do Case ObjectInfo(oExisting, OBJ_INFO_TYPE)
		Case OBJ_TYPE_PLINE
			'**continue Please
		Case Else
			Note "Please select a polyline to use this tool!"
			Exit Sub
	End Case

	If ObjectInfo(oExisting, OBJ_INFO_NPNTS) < 3 Then
		Note "The selected object has too few nodes. Not possible to remove another node!"
		Exit Sub
	End If

	nSegment	= 1
	nNode	= 1

	Alter Object oExisting
		Node Remove Position nSegment, nNode

	Update Selection
		Set OBJ = oExisting

	Close Table SelectionInfo(SEL_INFO_SELNAME)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTPolylineRemoveStartNode")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTPolylineRemoveEndNode

Dim	oExisting As Object,
	nSegment, nNode As Integer,
	fX, fY As Float

OnError GoTo ErrorOccured

	Fetch First From Selection
	oExisting	= Selection.OBJ

	Do Case ObjectInfo(oExisting, OBJ_INFO_TYPE)
		Case OBJ_TYPE_PLINE
			'**continue Please
		Case Else
			Note "Please select a line or a polyline to use this tool!"
			Exit Sub
	End Case

	If ObjectInfo(oExisting, OBJ_INFO_NPNTS) < 3 Then
		Note "The selected object has too few nodes. Not possible to remove another node!"
		Exit Sub
	End If

	nSegment	= ObjectInfo(oExisting, OBJ_INFO_NPOLYGONS)
	nNode	= ObjectInfo(oExisting, OBJ_INFO_NPOLYGONS + nSegment)

	Alter Object oExisting
		Node Remove Position nSegment, nNode

	Update Selection
		Set OBJ = oExisting

	Close Table SelectionInfo(SEL_INFO_SELNAME)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTPolylineRemoveEndNode")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTCombineIntoNew

Dim	oNew As Object,
	sTab As String

OnError GoTo ErrorOccured

	sTab	= MAPGetEditLayerName(FrontWindow())
	If sTab = "" Then
		Note "Please make sure that you have made a layer editable!"
		Exit Sub
	End If

	Create Object As Union
		From SelectionInfo(SEL_INFO_SELNAME)
		Into Variable oNew

	Insert Into sTab (OBJ)
		Values (oNew)

	Close Table SelectionInfo(SEL_INFO_SELNAME)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTCombineIntoNew")
	Call ERRShow()

End Sub


'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTCreateGaps

Dim	sTab As String,
	oPoint, oBuffer As Object,
	fX, fY, fZoom As Float

OnError GoTo ErrorOccured

	Set CoordSys Window FrontWindow()
	fX		= CommandInfo(CMD_INFO_X)
	fY		= CommandInfo(CMD_INFO_Y)
	oPoint 	= CreatePoint(fX, fY)

	sTab	= MAPGetEditLayerName(FrontWindow())
	If sTab = "" Then
		Note "Please make sure that you have made a layer editable!"
		Exit Sub
	End If

	Set Distance Units "m"
	fZoom	= MapperInfo(FrontWindow(), MAPPER_INFO_ZOOM)
	oBuffer	= CartesianBuffer(oPoint, 24, (fZoom / 4), "m")
	Select * From sTab
		Where OBJ Intersects oBuffer
		Into __GAP__QUERY

	If TableInfo("__GAP__QUERY", TAB_INFO_NROWS) > 1 Then
		Objects Check From __GAP__QUERY Into Table sTab
			Gap 1000 Units "sq m"
	End If

	Close Table __GAP__QUERY

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTCombineIntoNew")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes
'Parameters:
'
'**********************************************************************************************''
Sub DTDrawArrow

Dim	oDrawn, oLineStart, oLineEnd, oBuffer, oArrow, oArrowLine, oArrowTail, oArrowHead, oPoint As Object,
	fStartX, fStartY, fEndX, fEndY As Float,
	nWID, nNumNodes As Integer,
	sTab As String

OnError GoTo ErrorOccured

	nWID = FrontWindow()
	If nWID = 0 Then
		Note "Please use this tool in a map window!"
		Exit Sub
	End If
	If Not WindowInfo(nWID, WIN_INFO_TYPE) = WIN_MAPPER Then
		Note "Please use this tool in a map window!"
		Exit Sub
	End If

	sTab	= MAPGetEditLayerName(nWID)
	If sTab = "" Then
		Note "Please make sure that you have made a layer editable!"
		Exit Sub
	End If
	Set CoordSys Table sTab

	oDrawn	= CommandInfo(CMD_INFO_CUSTOM_OBJ)

	If not DLGArrow() Then
		Exit Sub
	End If

	oArrowLine = OBJRemoveDuplicateNodes(oDrawn, 0.5)	'meters

	'**Creating Arrow Head at the end of the line
	nNumNodes		= ObjectInfo(oArrowLine, OBJ_INFO_NPNTS)
	fEndX		= ObjectNodeX(oArrowLine, 1, nNumNodes)
	fEndY		= ObjectNodeY(oArrowLine, 1, nNumNodes)

	oBuffer		= Buffer(CreatePoint(fEndX, fEndY), 20, DLGAGetBufferWidth(), "m")
	oArrowLine	= Erase(oArrowLine, oBuffer)
	nNumNodes		= ObjectInfo(oArrowLine, OBJ_INFO_NPNTS)

	Create Pline
		Into Variable oLineEnd
		0
	Alter Object oLineEnd
		Node Add Position 1, 1 (ObjectNodeX(oArrowLine, 1, nNumNodes), ObjectNodeY(oArrowLine, 1, nNumNodes))
	Alter Object oLineEnd
		Node Add Position 1, 2 (fEndX, fEndY)

	Do Case DLGAGetArrowType(ARROW_END_HEAD)
		Case ARROW_END_TYPE_ROUNDED
			'Print "Arrow Head: Rounded"
			oArrowHead	= OBJCartesianCreateArrowHead(oLineEnd, 3, DLGAGetBufferWidth(), DLGAGetArrowLength(ARROW_END_HEAD), DLGAGetBufferResolution())
			'oArrowLine	= Erase(oArrowLine, oArrowHead)
		Case ARROW_END_TYPE_FLAT
			'Print "Arrow Head: Flat"
			oArrowHead	= OBJCartesianCreateArrowHead(oLineEnd, 2, DLGAGetBufferWidth(), DLGAGetArrowLength(ARROW_END_HEAD), DLGAGetBufferResolution())
			oArrowLine	= Erase(oArrowLine, oArrowHead)
		Case ARROW_END_TYPE_ARROW
			'Print "Arrow Head: Arrow"
			oArrowHead	= OBJCartesianCreateArrowHead(oLineEnd, 1, DLGAGetArrowWidth(ARROW_END_HEAD), DLGAGetArrowLength(ARROW_END_HEAD), DLGAGetBufferResolution())
			oArrowLine	= Erase(oArrowLine, oArrowHead)
	End Case

	'**Creating Arrow Tail at the start of the line
	fStartX		= ObjectNodeX(oArrowLine, 1, 1)
	fStartY		= ObjectNodeY(oArrowLine, 1, 1)

	oBuffer		= Buffer(CreatePoint(fStartX, fStartY), 20, DLGAGetBufferWidth(), "m")
	oArrowLine	= Erase(oArrowLine, oBuffer)

	Create Pline
		Into Variable oLineStart
		0
	Alter Object oLineStart
		Node Add Position 1, 1 (ObjectNodeX(oArrowLine, 1, 1), ObjectNodeY(oArrowLine, 1, 1))
	Alter Object oLineStart
		Node Add Position 1, 2 (fStartX, fStartY)

	Do Case DLGAGetArrowType(ARROW_END_TAIL)
		Case ARROW_END_TYPE_ROUNDED
			'Print "Arrow Tail: Rounded"
			oArrowTail	= OBJCartesianCreateArrowHead(oLineStart, 3, DLGAGetBufferWidth(), DLGAGetArrowLength(ARROW_END_TAIL), DLGAGetBufferResolution())
			'oArrowLine	= Erase(oArrowLine, oArrowTail)
		Case ARROW_END_TYPE_FLAT
			'Print "Arrow Tail: Flat"
			oArrowTail	= OBJCartesianCreateArrowHead(oLineStart, 2, DLGAGetBufferWidth(), DLGAGetArrowLength(ARROW_END_TAIL), DLGAGetBufferResolution())
			oArrowLine	= Erase(oArrowLine, oArrowTail)
		Case ARROW_END_TYPE_ARROW
			'Print "Arrow Tail: Arrow"
			oArrowTail	= OBJCartesianCreateArrowHead(oLineStart, 1, DLGAGetArrowWidth(ARROW_END_TAIL), DLGAGetArrowLength(ARROW_END_TAIL), DLGAGetBufferResolution())
			oArrowLine	= Erase(oArrowLine, oArrowTail)
	End Case

	oArrow		= Buffer(oArrowLine, 20, DLGAGetBufferWidth(), "m")

	oArrow		= Combine(oArrow, oArrowHead)
	oArrow		= Combine(oArrow, oArrowTail)

	Insert Into sTab (OBJ) Values (oArrow)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTDrawArrow")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Precisely
'Parameters:
'
'**********************************************************************************************''
Sub DTDrawIsocelesTrapez

Dim	nWID As Integer,
	fStartX, fStartY, fEndX, fEndY, fDirection, fDistance As Float,
	sTab As String,
	oPoint, oGeometry As Object

OnError GoTo ErrorOccured

	nWID = FrontWindow()
	If nWID = 0 Then
		Note "Please use this tool in a map window!"
		Exit Sub
	End If
	If Not WindowInfo(nWID, WIN_INFO_TYPE) = WIN_MAPPER Then
		Note "Please use this tool in a map window!"
		Exit Sub
	End If

	sTab	= MAPGetEditLayerName(nWID)
	If sTab = "" Then
		Note "Please make sure that you have made a layer editable!"
		Exit Sub
	End If
	Set CoordSys Table sTab

	fStartX	= CommandInfo(CMD_INFO_X)
	fStartY	= CommandInfo(CMD_INFO_Y)
	fEndX	= CommandInfo(CMD_INFO_X2)
	fEndY	= CommandInfo(CMD_INFO_Y2)

'	Note FormatNumber$(fStartX) & " | " & FormatNumber$(fStartY)

	fDirection	= MATHGetDirection(fStartX, fStartY, fEndX, fEndY)
	fDistance		= Round(CartesianDistance(fStartX, fStartY, fEndX, fEndY, "m"), 0.001)

'	Note FormatNumber$(fDirection) & " | " & FormatNumber$(fDistance)
	If fDistance = -1 Then
		fDistance		= Round(Distance(fStartX, fStartY, fEndX, fEndY, "m"), 0.001)
	End If

	If Not DLGIsoscelesTrapez(fStartX, fStartY, fDirection, fDistance, -1, -1, -1) Then
		Exit Sub
	End If

	oPoint	= CreatePoint(DLGITGetX(), DLGITGetY())
	oGeometry = OBJCreateTrapez(oPoint, DLGITGetDirection(), DLGITGetLength(), DLGITGetWidthAtStart(), DLGITGetWidthAtEnd(), DLGITAddMidPointNode(), DLGITGetCalculationMethod())

	Insert Into sTab (OBJ) Values (oGeometry)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTDrawIsocelesTrapez")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'	:
'Return value:
'
'**********************************************************************************************''
Function DTGetIconsFile() As String

OnError GoTo ErrorOccured

	If msIconsFile = "" Then
		msIconsFile	= ApplicationDirectory$() & "DrawTools.dll"
	End If
	DTGetIconsFile = msIconsFile
	Exit Function
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTGetIconsFile")
	Call ERRShow()

End Function

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes Business Insight
'Parameters:
'
'**********************************************************************************************''
Sub DTSetIconsFile(ByVal sFile As String)

OnError GoTo ErrorOccured

	msIconsFile	= sFile
	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTSetIconsFile")
	Call ERRShow()

End Sub

'**********************************************************************************************''
'Created by Peter Horsbøll Møller, Pitney Bowes
'Parameters:
'
'**********************************************************************************************''
Sub DTCreateAnglePointAlong

Dim	sTab, sNodeTab, sOutputTabFile As String,
	nRow, nSegm, nNode As Integer,
	oCur As Object,
	tCur, tPrev, tNext As T_MI_POINT,
	fAnglePrev, fAngleNext, fAngle As Float,
	aObj, aRowID As Alias,
	symCur As Symbol

OnError GoTo ErrorOccured

	sTab = DLGSelectTable(TAB_USE_ALL_MAPPABLE_BUT_IMAGES, "Calculate Node Angles", "Select table to run thru", "", FALSE, sTab)
	If sTab = "" Then
		Exit Sub
	End If

	Set CoordSys Table sTab

'	If TableInfo(sTab, TAB_INFO_TYPE) = TAB_TYPE_RESULT Then
		sNodeTab	= "Node Angles" & DATEGetISODate(CurDate())
'	Else
'		sNodeTab	= PathToFileName$(TableInfo(sTab, TAB_INFO_TABFILE),
'	End If
	sOutputTabFile = PathToDirectory$(TempFileName$("")) & sNodeTab & ".tab"
	sNodeTab		= PathToTableName$(sOutputTabFile)

	If not TABIsOpen(sNodeTab) Then
		Create Table sNodeTab
			( TABLE_NAME		Char(50)
			, RECORD_NO		Integer
			, NODE_NO			Integer
			, MINIMUM_ANGLE	Float
			)
			File sOutputTabFile
		Create Map For sNodeTab
			Using sTab
	End If

'	Set Table Redraw Off

	aObj		= sTab & ".OBJ"
	aRowID	= sTab & ".ROWID"
	symCur	= CurrentSymbol()

	Fetch First From sTab
	Do Until EOT(sTab)
		oCur = aObj
		nRow	= aRowID

		If ObjectInfo(oCur, OBJ_INFO_TYPE) In (OBJ_TYPE_PLINE, OBJ_TYPE_REGION) Then
			For nSegm = 1 To ObjectInfo(oCur, OBJ_INFO_NPOLYGONS)
				tPrev.fX	= ObjectNodeX(oCur, nSegm, 1)
				tPrev.fY	= ObjectNodeY(oCur, nSegm, 1)
				tCur.fX	= ObjectNodeX(oCur, nSegm, 2)
				tCur.fY	= ObjectNodeY(oCur, nSegm, 2)

				For nNode = 2 To (ObjectInfo(oCur, OBJ_INFO_NPOLYGONS + nSegm) - 1)
'					tPrev.fX	= ObjectNodeX(oCur, nSegm, (nNode - 1))
'					tPrev.fY	= ObjectNodeY(oCur, nSegm, (nNode - 1))
'					tCur.fX	= ObjectNodeX(oCur, nSegm, nNode)
'					tCur.fY	= ObjectNodeY(oCur, nSegm, nNode)
					tNext.fX	= ObjectNodeX(oCur, nSegm, (nNode + 1))
					tNext.fY	= ObjectNodeY(oCur, nSegm, (nNode + 1))

					fAnglePrev	= MATHGetDirection(tCur.fX, tCur.fY, tPrev.fX, tPrev.fY)
					fAngleNext	= MATHGetDirection(tCur.fX, tCur.fY, tNext.fX, tNext.fY)

'					Print "Node: " & nNode & ": Angle 1: " & FormatNumber$(fAnglePrev) & " - Angle 2: " & FormatNumber$(fAngleNext)

					fAngle		= Maximum(fAnglePrev, fAngleNext) - Minimum(fAnglePrev, fAngleNext)
					fAngle		= Minimum(fAngle, (360 - fAngle))

'					Print "Angle: " & FormatNumber$(fAngle) & " at " & tCur.fX & " | " & tCur.fY

					Insert Into sNodeTab
						(TABLE_NAME, RECORD_NO, NODE_NO, MINIMUM_ANGLE, OBJ)
						Values
						(sTab, nRow, nNode, fAngle, tmipToPointWithStyle(tCur, symCur))

					tPrev.fX	= tCur.fX
					tPrev.fY	= tCur.fY
					tCur.fX	= tNext.fX
					tCur.fY	= tNext.fY
				Next

				If ObjectInfo(oCur, OBJ_INFO_TYPE) = OBJ_TYPE_REGION Then
'					tPrev.fX	= ObjectNodeX(oCur, nSegm, (ObjectInfo(oCur, OBJ_INFO_NPOLYGONS + nSegm) - 1))
'					tPrev.fY	= ObjectNodeY(oCur, nSegm, (ObjectInfo(oCur, OBJ_INFO_NPOLYGONS + nSegm) - 1))
'					tCur.fX	= ObjectNodeX(oCur, nSegm, (ObjectInfo(oCur, OBJ_INFO_NPOLYGONS + nSegm)))
'					tCur.fY	= ObjectNodeY(oCur, nSegm, (ObjectInfo(oCur, OBJ_INFO_NPOLYGONS + nSegm)))
					tNext.fX	= ObjectNodeX(oCur, nSegm, 2)
					tNext.fY	= ObjectNodeY(oCur, nSegm, 2)

					fAnglePrev	= MATHGetDirection(tCur.fX, tCur.fY, tPrev.fX, tPrev.fY)
					fAngleNext	= MATHGetDirection(tCur.fX, tCur.fY, tNext.fX, tNext.fY)

'					Print "Node: 1: Angle 1: " & FormatNumber$(fAnglePrev) & " - Angle 2: " & FormatNumber$(fAngleNext)

					fAngle		= Maximum(fAnglePrev, fAngleNext) - Minimum(fAnglePrev, fAngleNext)
					fAngle		= Minimum(fAngle, (360 - fAngle))

'					Print "Angle: " & FormatNumber$(fAngle) & " at " & tCur.fX & " | " & tCur.fY

					Insert Into sNodeTab
						(TABLE_NAME, RECORD_NO, NODE_NO, MINIMUM_ANGLE, OBJ)
						Values
						(sTab, nRow, 1, fAngle, tmipToPointWithStyle(tCur, symCur))
				End If
			Next
		End If

		Fetch Next From sTab
	Loop

'	Set Table Redraw On

	Call RBNNotificationShow(PRGIGetApplicationName(), "The nodes are stored in a temporary table. Rename the table to keep the result.", Notify_Info, 20000)

	Exit Sub
'-------------------------
ErrorOccured:
	Call ERRCreate(Err(), Error$(), "DTCreateAnglePointAlong")
	Call ERRShow()

End Sub